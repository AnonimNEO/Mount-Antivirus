#–î–∞–Ω–Ω–æ–µ –°–≤–æ–±–æ–¥–Ω–æ–µ –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ –ª–∏—Ü–µ–Ω–∑–∏–∏ GPL-3.0-only –∏–ª–∏ GPL-3.0-or-later
#–í—ã –∏–º–µ–µ—Ç–µ –ø—Ä–∞–≤–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, –∏–∑–º–µ–Ω—è—Ç—å, —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—Ç—å, –≤–∑–∏–º–∞—Ç—å –ø–ª–∞—Ç—É –∑–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–∫—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –∫–æ–ø–∏–∏, –∏ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ —Å–≤–æ–µ–º—É —É—Å–º–æ—Ç—Ä–µ–Ω–∏—é –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—É—é –∑–∞—â–∏—Ç—É –≤ –æ–±–º–µ–Ω –Ω–∞ –ø–ª–∞—Ç—É
#–î–õ–Ø –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –î–ê–ù–ù–û–ì–û –°–í–û–ë–û–î–ù–û–ì–û –ü–†–û–ì–†–ê–ú–ú–ù–û–ì–û –û–ë–ï–°–ü–ï–ß–ï–ù–ò–Ø, –í–ê–ú –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø –ü–†–ò–ù–Ø–¢–ò–ï –õ–ò–¶–ï–ù–ó–ò–ò Gnu GPL v3.0 –∏–ª–∏ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
#–í –°–õ–£–ß–ê–ï –†–ê–°–ü–†–û–°–¢–†–ê–ù–ï–ù–ò–Ø –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ô –ü–†–û–ì–†–ê–ú–ú–´ –ò/–ò–õ–ò –ú–û–î–ï–†–ù–ò–ó–ò–†–û–í–ê–ù–ù–û–ô –í–ï–†–°–ò–ò –ò/–ò–õ–ò –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –ò–°–•–û–î–ù–ò–ö–û–í –í –°–í–û–ï–ô –ü–†–û–ì–†–ê–ú–ú–ï, –í–´ –û–ë–Ø–ó–ê–ù–´ –ó–ê–î–û–ö–£–ú–ï–ù–¢–ò–†–û–í–ê–¢–¨ –í–°–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ö–û–î–ï –ò –ü–†–ï–î–û–°–¢–ê–í–ò–¢–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú –í–û–ó–ú–û–ñ–ù–û–°–¢–¨ –ü–û–õ–£–ß–ò–¢–¨ –ò–°–•–û–î–ù–ò–ö–ò –í–ê–®–ï–ô –ö–û–ü–ò–ò –ü–†–û–ì–†–ê–ú–ú–´, –ê –¢–ê–ö–ñ–ï –£–ö–ê–ó–ê–¢–¨ –ê–í–¢–û–†–°–¢–í–û –î–ê–ù–ù–û–ì–û –ü–†–û–ì–†–ê–ú–ú–ù–û–ì–û –û–ë–ï–°–ü–ï–ß–ï–ù–ò–Ø
#–ü–†–ò –†–ê–°–ü–†–û–°–¢–†–ê–ù–ï–ù–ò–ò –ü–†–û–ì–†–ê–ú–ú–´ –í–´ –û–ë–Ø–ó–ê–ù–´ –ü–†–ï–î–û–°–¢–ê–í–ò–¢–¨ –í–°–ï –¢–ï–ñ–ï –ü–†–ê–í–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ß–¢–û –ò –ú–´ –í–ê–ú, –ê –¢–ê–ö–ñ–ï –õ–ò–¶–ï–ù–ó–ò–Ø GPL v3
#–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é –ª–∏—Ü–µ–Ω–∑–∏–∏ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –§–æ–Ω–¥–∞ –°–≤–æ–±–æ–¥–Ω–æ–≥–æ –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –û–±–µ—Å–ø–µ—á–µ–Ω–∏—è - https://www.gnu.org/licenses/gpl-3.0.html
#–ò–ª–∏ –≤ —Ñ–∞–π–ª–µ COPYING.txt –≤ –∞—Ä—Ö–∏–≤–µ —Å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–æ–º
#Copyleft üÑØ NEO Organization, Departament K 2024 - 2025
#Coded by @AnonimNEO (Telegram)

#–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
from tkinter import ttk, messagebox
import tkinter as tk
#–†–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
import subprocess
import os
#–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
from loguru import logger

from RS import random_string

users_manager_version = "0.1.7 Pre-Alpha"


def run_net_command(args):
    try:
        subprocess.run(["net"] + args, capture_output=True, text=True, check=True, creationflags=subprocess.CREATE_NO_WINDOW)
        return True
    except subprocess.CalledProcessError as e:
        logger.error(f"UM - –ö–æ–º–∞–Ω–¥–∞ net –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π:\n{e.stderr}")
        return False
    except Exception as e:
        logger.exception(f"UM - –°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã.\n{e}")
        return False



class UserManager:
    def __init__(self, master):
        self.master = master
        master.title(random_string())
        master.geometry("275x285")

        self.users = [] 
        self.current_username = os.getlogin() 

        self.create_widgets()
        self.load_users()



    def create_widgets(self):
        self.tree = ttk.Treeview(self.master, columns=("username",), show="headings")
        self.tree.heading("username", text="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
        self.tree.column("username", width=275)
        self.tree.pack(pady=10, padx=10, fill=tk.BOTH, expand=True)

        button_frame = tk.Frame(self.master)
        button_frame.pack(pady=5)

        self.create_button = tk.Button(button_frame, text="–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", command=self.create_user)
        self.create_button.pack(side=tk.LEFT, padx=5)

        self.delete_button = tk.Button(button_frame, text="–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö", command=self.delete_users)
        self.delete_button.pack(side=tk.LEFT, padx=5)



    def load_users(self):
        try:
            cmd = (
                "powershell -Command \"Get-LocalUser | "
                "Where-Object { $_.SID -like 'S-1-5-21-*' -and $_.Enabled -eq $true } | "
                "Select-Object -ExpandProperty Name\""
            )

            #–í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É
            result = subprocess.check_output(cmd, shell=True, text=True, stderr=subprocess.PIPE, encoding='cp866')
            lines = result.strip().splitlines()

            system_blacklist = [
                "Administrator", "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", 
                "Guest", "–ì–æ—Å—Ç—å", 
                "DefaultAccount", "WDAGUtilityAccount", 
                "UtilityAccount", "SystemAdmin"
            ]

            self.users = []
            for line in lines:
                name = line.strip()
                if name and not any(black.lower() == name.lower() for black in system_blacklist):
                    self.users.append(name)

            self.update_tree()

        except Exception as e:
            logger.exception("UM - –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
            messagebox.showerror(random_string(), f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n{e}")



    def update_tree(self):
        for item in self.tree.get_children():
            self.tree.delete(item)
        for username in self.users:
            self.tree.insert("", tk.END, values=(username,))



    def create_user(self):
        create_window = tk.Toplevel(self.master)
        create_window.title(random_string())
        create_window.geometry("150x150")

        tk.Label(create_window, text="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:").pack(pady=2)
        username_entry = tk.Entry(create_window)
        username_entry.pack(pady=2)

        tk.Label(create_window, text="–ü–∞—Ä–æ–ª—å:").pack(pady=2)
        password_entry = tk.Entry(create_window, show="*")
        password_entry.pack(pady=2)

        def confirm_creation():
            username = username_entry.get().strip()
            password = password_entry.get().strip()

            if not username or not password:
                messagebox.showwarning(random_string(), "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.")
                return

            if run_net_command(["user", username, password, "/add"]):
                logger.info(f"UM - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} —Å–æ–∑–¥–∞–Ω.")
                self.load_users()
                create_window.destroy()
            else:
                messagebox.showerror(random_string(), "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")

        create_button = tk.Button(create_window, text="–°–æ–∑–¥–∞—Ç—å", command=confirm_creation)
        create_button.pack(pady=10)



    def delete_users(self):
        selected_items = self.tree.selection()
        if not selected_items:
            messagebox.showwarning(random_string(), "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
            return

        for item in selected_items:
            username = self.tree.item(item, "values")[0]
            if username.lower() == self.current_username.lower():
                messagebox.showwarning(random_string(), f"–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–µ–±—è ({username}).")
                continue

            if run_net_command(["user", username, "/delete"]):
                logger.info(f"UM - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} —É–¥–∞–ª–µ–Ω.")
            else:
                logger.error(f"UM - –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {username}.")

        self.load_users()



def UM():
    try:
        root = tk.Tk()
        app = UserManager(root)
        root.mainloop()
    except Exception as e:
        logger.critical(f"–í –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–µ UsersManager –ø—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞!\n{e}")