#–î–∞–Ω–Ω–æ–µ –°–≤–æ–±–æ–¥–Ω–æ–µ –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ –ª–∏—Ü–µ–Ω–∑–∏–∏ GPL-3.0-only –∏–ª–∏ GPL-3.0-or-later
#–í—ã –∏–º–µ–µ—Ç–µ –ø—Ä–∞–≤–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, –∏–∑–º–µ–Ω—è—Ç—å, —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—Ç—å, –≤–∑–∏–º–∞—Ç—å –ø–ª–∞—Ç—É –∑–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–∫—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –∫–æ–ø–∏–∏, –∏ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ —Å–≤–æ–µ–º—É —É—Å–º–æ—Ç—Ä–µ–Ω–∏—é –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—É—é –∑–∞—â–∏—Ç—É –≤ –æ–±–º–µ–Ω –Ω–∞ –ø–ª–∞—Ç—É
#–î–õ–Ø –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –î–ê–ù–ù–û–ì–û –°–í–û–ë–û–î–ù–û–ì–û –ü–†–û–ì–†–ê–ú–ú–ù–û–ì–û –û–ë–ï–°–ü–ï–ß–ï–ù–ò–Ø, –í–ê–ú –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø –ü–†–ò–ù–Ø–¢–ò–ï –õ–ò–¶–ï–ù–ó–ò–ò Gnu GPL v3.0 –∏–ª–∏ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
#–í –°–õ–£–ß–ê–ï –†–ê–°–ü–†–û–°–¢–†–ê–ù–ï–ù–ò–Ø –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ô –ü–†–û–ì–†–ê–ú–ú–´ –ò/–ò–õ–ò –ú–û–î–ï–†–ù–ò–ó–ò–†–û–í–ê–ù–ù–û–ô –í–ï–†–°–ò–ò –ò/–ò–õ–ò –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –ò–°–•–û–î–ù–ò–ö–û–í –í –°–í–û–ï–ô –ü–†–û–ì–†–ê–ú–ú–ï, –í–´ –û–ë–Ø–ó–ê–ù–´ –ó–ê–î–û–ö–£–ú–ï–ù–¢–ò–†–û–í–ê–¢–¨ –í–°–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ö–û–î–ï –ò –ü–†–ï–î–û–°–¢–ê–í–ò–¢–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú –í–û–ó–ú–û–ñ–ù–û–°–¢–¨ –ü–û–õ–£–ß–ò–¢–¨ –ò–°–•–û–î–ù–ò–ö–ò –í–ê–®–ï–ô –ö–û–ü–ò–ò –ü–†–û–ì–†–ê–ú–ú–´, –ê –¢–ê–ö–ñ–ï –£–ö–ê–ó–ê–¢–¨ –ê–í–¢–û–†–°–¢–í–û –î–ê–ù–ù–û–ì–û –ü–†–û–ì–†–ê–ú–ú–ù–û–ì–û –û–ë–ï–°–ü–ï–ß–ï–ù–ò–Ø
#–ü–†–ò –†–ê–°–ü–†–û–°–¢–†–ê–ù–ï–ù–ò–ò –ü–†–û–ì–†–ê–ú–ú–´ –í–´ –û–ë–Ø–ó–ê–ù–´ –ü–†–ï–î–û–°–¢–ê–í–ò–¢–¨ –í–°–ï –¢–ï–ñ–ï –ü–†–ê–í–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ß–¢–û –ò –ú–´ –í–ê–ú, –ê –¢–ê–ö–ñ–ï –õ–ò–¶–ï–ù–ó–ò–Ø GPL v3
#–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é –ª–∏—Ü–µ–Ω–∑–∏–∏ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –§–æ–Ω–¥–∞ –°–≤–æ–±–æ–¥–Ω–æ–≥–æ –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –û–±–µ—Å–ø–µ—á–µ–Ω–∏—è - https://www.gnu.org/licenses/gpl-3.0.html
#–ò–ª–∏ –≤ —Ñ–∞–π–ª–µ COPYING.txt –≤ –∞—Ä—Ö–∏–≤–µ —Å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–æ–º
#Copyleft üÑØ NEO Organization, Departament K 2024 - 2025
#Coded by @AnonimNEO (Telegram)

#–†–∏—Å–æ–≤–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –≤ —Ç—Ä–µ–µ –∏ –≤—Å—Ç–∞–≤–∫–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫
from PIL import Image, ImageDraw, ImageFont
#–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –û—à–∏–±–æ–∫
from loguru import logger
#–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∞–≤ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
from elevate import elevate
#–î–≤–∏–∂–æ–∫ –∏–∫–æ–Ω–∫–∏ –≤ —Ç—Ä–µ–µ
from pystray import MenuItem, Menu
import pystray
#–†–∞–±–æ—Ç–∞ —Å –ø–æ—Ç–æ–∫–∞–º–∏
#from threading import Thread
import threading
#–†–∞–±–æ—Ç–∞ —Å–æ –≤—Ä–µ–º–µ–Ω–∏–º
import time
#–†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –∏ –û–°
import os

#import ctypes
#ctypes import windll
#–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º DPI Awareness –ü–ï–†–ï–î —Å–æ–∑–¥–∞–Ω–∏–µ–º –ª—é–±—ã—Ö –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
#windll.shcore.SetProcessDpiAwareness(1)

#–ì–ª–æ–±–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–µ—Ä—Å–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
global autorun_master_version, clear_cache_version, exit_version, file_manager_version, load_protection_version, unlocker_version, on_board_pc_version, other_komponents_version, restart_version, random_string_version, run_version, scarecrow_protection_verison

#–ò–º–ø–æ—Ä—Ç –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
from AP import AP
from ARM import ARM, autorun_master_version
from CC import CC, clear_cache_version
from config import *
from E import ask_exit, exit_version
from EC import edit_criticality_version
from FM import FM, file_manager_version
from LP import LP, load_protection_version
from MU import MU, unlocker_version
from OBPC import OBPC, on_board_pc_version
from OF import open_with, get_current_disc, load_bush, unload_bush, other_komponents_version
from PM import PM, process_manager_version
from R import R, restart_version
from RS import random_string_version
from Run import Run, run_version
from SAU import SAU, settings_and_update_version
from SP import SP, scarecrow_protection_version
from UA import UA, unlock_all_version

elevate()

#–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
global T_log_txt, start_interface
font_trey = "arial.ttf"
trey_version = "2.0.2 Beta"

if not os.path.exists(log_path):
    os.makedirs(log_path)
logger.add(f"{log_path}\\{T_log_txt}", format="{time} {level} {message}", rotation="100 KB", compression="zip")

def check_is_recovery():
    #–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Ä–µ–µ—Å—Ç—Ä (—Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ –¥–ª—è —Å—Ä–µ–¥—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)
    try:
        import winreg
        # –í WinPE —ç—Ç–æ—Ç –∫–ª—é—á —á–∞—Å—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å—Ä–µ–¥—É –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏
        reg_key = winreg.OpenKey(winreg.HKEY_LOCAL_MACHINE, r"SYSTEM\Setup", 0, winreg.KEY_READ)
        setup_type, _ = winreg.QueryValueEx(reg_key, "SystemSetupInProgress")
        winreg.CloseKey(reg_key)
        if setup_type == 1:
            return True
    except Exception:
        pass

    #–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –Ω–∞–ª–∏—á–∏—é –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
    #if os.path.exists("X:\\Windows\\"):
    #    return True

    return False

run_in_recovery = False
try:
    #–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    try:
        run_in_recovery = check_is_recovery()
        if run_in_recovery:
            logger.warning("T - –ó–∞–ø—É—Å–∫ –≤ —Å—Ä–µ–¥–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –®indows")
        else:
            logger.info("T - –ó–∞–ø—É—Å–∫ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Å—Ä–µ–¥–µ –®indows")
    except Exception as e:
        run_in_recovery = True
        logger.error(f"T - –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ —Å—Ä–µ–¥—ã:\n{e}")

    if run_in_recovery:
        current_disc, found_disc = get_current_disc(run_in_recovery)
        if found_disc:
            logger.info(f"T - –ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Å—Ç–æ–≤ —Ä–µ–µ—Å—Ç—Ä–∞ —Å –¥–∏—Å–∫–∞ {current_disc}...")
            load_bush(current_disc)

except Exception as e:
    logger.error(f"T - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")

#def set_dpi_awareness():
#    if run_in_recovery:
#        return
#    try:
#        #–ü—ã—Ç–∞–µ–º—Å—è –≤—ã–∑–≤–∞—Ç—å –±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é (Windows 8.1+)
#        ctypes.windll.shcore.SetProcessDpiAwareness(1)
#    except Exception:
#        try:
#            #–û—Ç–∫–∞—Ç –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Å–∏—Å—Ç–µ–º (Windows Vista/7)
#            ctypes.windll.user32.SetProcessDPIAware()
#        except Exception as e:
#            logger.debug(f"T - –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å DPI Awareness: {e}")
#
#set_dpi_awareness()

#–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
try:
    #if not run_in_recovery:
    #    #–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º DPI-Awareness –¥–ª—è Windows
    #    try:
    #        ctypes.windll.shcore.SetProcessDpiAwareness(1) # –£–±–∏—Ä–∞–µ—Ç –æ—à–∏–±–∫—É –º–æ–¥—É–ª—è –≤ pystray
    #    except Exception as e:
    #        logger.warning(f"T - –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å DPI Awareness: {e}")

    if not run_in_recovery:
        try:
            #–°–æ–∑–¥–∞–Ω–∏–µ –ò–∫–æ–Ω–∫–∏
            def create_image(width, height):
                image = Image.new("RGB", (width, height), (255, 0, 0))
                square = ImageDraw.Draw(image)
                square.rectangle(
                    (width // 2 - 10, height // 2 - 10, width // 2 + 10, height // 2 + 10),
                    fill=(0, 0, 255)
                )

                font = None
                #–°–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π –∫ —à—Ä–∏—Ñ—Ç—É Arial –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ä–µ–¥
                font_paths = [font_trey, "C:\\Windows\\Fonts\\arial.ttf", "/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf"]

                for path in font_paths:
                    try:
                        font = ImageFont.truetype(path, 24)
                        break
                    except Exception:
                        continue

                if font is None:
                    font = ImageFont.load_default()
                    logger.warning("T - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —à—Ä–∏—Ñ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")

                text = "=]"
                text_bbox = square.textbbox((0, 0), text, font=font)
                text_width = text_bbox[2] - text_bbox[0]
                text_height = text_bbox[3] - text_bbox[1]
                text_position = (width // 2 - text_width // 2, height // 2 - text_height // 2)
                square.text(text_position, text, fill=(255, 0, 0), font=font)
                return image

            def start_icon():
                if run_in_recovery:
                    logger.warning("T - –†–µ–∂–∏–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: –¢—Ä–µ–π –æ—Ç–∫–ª—é—á–µ–Ω.")
                    return 
                try:
                    icon.visible = True
                except Exception as e:
                    logger.error(f"T - –û—à–∏–±–∫–∞ —Ç—Ä–µ—è:\n{e}")

            #–°–æ–∑–¥–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –ê–Ω–ª–æ–∫–µ—Ä–∞
            unlocker_menu = Menu(
                MenuItem("–§–∞–π–ª–æ–≤—ã–π –ú–µ–Ω–µ–¥–∂–µ—Ä", lambda:FM(run_in_recovery)),
                MenuItem("–ú–∞—Å—Ç–µ—Ä –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏", lambda:ARM(run_in_recovery)),
                MenuItem("Scarecrow Protection", lambda:SP(run_in_recovery)),
                MenuItem("–ó–∞–ø—É—Å—Ç–∏—Ç—å –û—á–∏—Å—Ç–∫—É Temp", lambda:CC(run_in_recovery)),
                MenuItem("–û—Ç–∫—Ä—ã—Ç—å —Å –ü–æ–º–æ—â—å—é", open_with),
                MenuItem("–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ü–ö", R)
            )

            #–ú–µ–Ω—é –ü–æ –ü–ö–ú
            image = create_image(20, 20)
            menu = Menu(
                MenuItem("–û—Ç–∫—Ä—ã—Ç—å –ú–æ–Ω—Ç–∏—Ä–æ–≤–∫–∞ –ê–Ω–ª–æ–∫–µ—Ä", lambda:MU(run_in_recovery)),
                MenuItem("–£—Ç–∏–ª–∏—Ç—ã", unlocker_menu),
                MenuItem("–ó–∞–ø—É—Å—Ç–∏—Ç—å Load Protection", lambda:LP(run_in_recovery)),
                MenuItem("–ú–µ–Ω–µ–¥–∂–µ—Ä –ü—Ä–æ—Ü–µ—Å—Å–æ–≤", lambda:PM(run_in_recovery)),
                MenuItem("–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –í—Å–µ–≥–æ", lambda:UA(run_in_recovery)),
                MenuItem("–ó–∞–ø—É—Å—Ç–∏—Ç—å –û—Ç –ò–º–µ–Ω–∏ –ê–¥–º–∏–Ω–∞", Run),
                MenuItem("–û –ü—Ä–æ–≥—Ä–∞–º–º–µ", lambda:AP(autorun_master_version, clear_cache_version, exit_version, edit_criticality_version, file_manager_version, load_protection_version, unlocker_version, on_board_pc_version, other_komponents_version, process_manager_version, restart_version, random_string_version, run_version, scarecrow_protection_version, settings_and_update_version, trey_version, unlock_all_version)),
                MenuItem("–ù–∞—Å—Ç—Ä–æ–π–∫–∏", SAU),
                MenuItem("–í—ã—Ö–æ–¥", ask_exit)
            )

            icon = pystray.Icon("Mount_Antivirus_Icon", image, "Mount Antivirus", menu)

            if start_interface == "icon" or start_interface == "window":
                #–ó–∞–ø—É—Å–∫–∞–µ–º –∏–∫–æ–Ω–∫—É –≤ —Ç—Ä–µ–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ.
                thread_icon = threading.Thread(target=icon.run)
                thread_icon.daemon = True #–î–µ–ª–∞–µ–º –ø–æ—Ç–æ–∫ –¥–µ–º–æ–Ω–æ–º, —á—Ç–æ–±—ã –æ–Ω –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
                thread_icon.start()

                start_icon()

            if start_obpc:
                #–ó–∞–ø—É—Å–∫–∞–µ–º –ì–æ–ª–æ—Å–æ–≤–æ–µ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (OBPC) –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ.
                thread_obpc = threading.Thread(target=lambda:OBPC(run_in_recovery))
                thread_obpc.daemon = True
                thread_obpc.start()

            if start_lp:
                #–ó–∞–ø—É—Å–∫–∞–µ–º LoadProtection (LP) –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ.
                thread_lp = threading.Thread(target=lambda:LP(run_in_recovery))
                thread_lp.daemon = True
                thread_lp.start()

            if start_interface == "window" or start_interface == "only-windows":
                MU(run_in_recovery)

            while True:
                time.sleep(1)
        except Exception as e:
            run_in_recovery = True
            logger.warning("T - –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–∫–æ–Ω–∫–∏, –∑–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∫–∞–≤–µ—Ä–∏...")

    if run_in_recovery:
        logger.info("T - –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∫–∞–≤–µ—Ä–∏...")
        MU(run_in_recovery)

except Exception as e:
    run_in_recovery = True
    logger.critical(f"–í –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–µ Trey –ø—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞!\n{e}")
    logger.info("T - –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∫–∞–≤–µ—Ä–∏...")
    MU(run_in_recovery)
finally:
    if run_in_recovery:
        logger.info("T - –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã, –≤—ã–≥—Ä—É–∑–∫–∞ –∫—É—Å—Ç–æ–≤ —Ä–µ–µ—Å—Ç—Ä–∞...")
        unload_bush()
