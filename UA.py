#–î–∞–Ω–Ω–æ–µ –°–≤–æ–±–æ–¥–Ω–æ–µ –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ –ª–∏—Ü–µ–Ω–∑–∏–∏ GPL-3.0-only –∏–ª–∏ GPL-3.0-or-later
#–í—ã –∏–º–µ–µ—Ç–µ –ø—Ä–∞–≤–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, –∏–∑–º–µ–Ω—è—Ç—å, —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—Ç—å, –≤–∑–∏–º–∞—Ç—å –ø–ª–∞—Ç—É –∑–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–∫—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –∫–æ–ø–∏–∏, –∏ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ —Å–≤–æ–µ–º—É —É—Å–º–æ—Ç—Ä–µ–Ω–∏—é –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—É—é –∑–∞—â–∏—Ç—É –≤ –æ–±–º–µ–Ω –Ω–∞ –ø–ª–∞—Ç—É
#–î–õ–Ø –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –î–ê–ù–ù–û–ì–û –°–í–û–ë–û–î–ù–û–ì–û –ü–†–û–ì–†–ê–ú–ú–ù–û–ì–û –û–ë–ï–°–ü–ï–ß–ï–ù–ò–Ø, –í–ê–ú –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø –ü–†–ò–ù–Ø–¢–ò–ï –õ–ò–¶–ï–ù–ó–ò–ò Gnu GPL v3.0 –∏–ª–∏ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
#–í –°–õ–£–ß–ê–ï –†–ê–°–ü–†–û–°–¢–†–ê–ù–ï–ù–ò–Ø –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ô –ü–†–û–ì–†–ê–ú–ú–´ –ò/–ò–õ–ò –ú–û–î–ï–†–ù–ò–ó–ò–†–û–í–ê–ù–ù–û–ô –í–ï–†–°–ò–ò –ò/–ò–õ–ò –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –ò–°–•–û–î–ù–ò–ö–û–í –í –°–í–û–ï–ô –ü–†–û–ì–†–ê–ú–ú–ï, –í–´ –û–ë–Ø–ó–ê–ù–´ –ó–ê–î–û–ö–£–ú–ï–ù–¢–ò–†–û–í–ê–¢–¨ –í–°–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ö–û–î–ï –ò –ü–†–ï–î–û–°–¢–ê–í–ò–¢–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú –í–û–ó–ú–û–ñ–ù–û–°–¢–¨ –ü–û–õ–£–ß–ò–¢–¨ –ò–°–•–û–î–ù–ò–ö–ò –í–ê–®–ï–ô –ö–û–ü–ò–ò –ü–†–û–ì–†–ê–ú–ú–´, –ê –¢–ê–ö–ñ–ï –£–ö–ê–ó–ê–¢–¨ –ê–í–¢–û–†–°–¢–í–û –î–ê–ù–ù–û–ì–û –ü–†–û–ì–†–ê–ú–ú–ù–û–ì–û –û–ë–ï–°–ü–ï–ß–ï–ù–ò–Ø
#–ü–†–ò –†–ê–°–ü–†–û–°–¢–†–ê–ù–ï–ù–ò–ò –ü–†–û–ì–†–ê–ú–ú–´ –í–´ –û–ë–Ø–ó–ê–ù–´ –ü–†–ï–î–û–°–¢–ê–í–ò–¢–¨ –í–°–ï –¢–ï–ñ–ï –ü–†–ê–í–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ß–¢–û –ò –ú–´ –í–ê–ú, –ê –¢–ê–ö–ñ–ï –õ–ò–¶–ï–ù–ó–ò–Ø GPL v3
#–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é –ª–∏—Ü–µ–Ω–∑–∏–∏ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –§–æ–Ω–¥–∞ –°–≤–æ–±–æ–¥–Ω–æ–≥–æ –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –û–±–µ—Å–ø–µ—á–µ–Ω–∏—è - https://www.gnu.org/licenses/gpl-3.0.html
#–ò–ª–∏ –≤ —Ñ–∞–π–ª–µ COPYING.txt –≤ –∞—Ä—Ö–∏–≤–µ —Å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–æ–º
#Copyleft üÑØ NEO Organization, Departament K 2024 - 2025
#Coded by @AnonimNEO (Telegram)

import winreg
from loguru import logger
from typing import Tuple, Any

from OF import get_offline_reg_path, loaded_hive_names

unlock_all_version = "1.1.1 Beta"



#–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ '–Ω—É–ª–µ–≤–æ–µ' –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
def get_new_value_for_type(reg_type: int) -> Tuple[Any, int]:
    if reg_type in (winreg.REG_DWORD, winreg.REG_QWORD):
        return 0, reg_type
    elif reg_type in (winreg.REG_SZ, winreg.REG_EXPAND_SZ):
        return "", reg_type
    elif reg_type == winreg.REG_MULTI_SZ:
        return [], reg_type
    elif reg_type == winreg.REG_BINARY:
        return b"", reg_type
    return None, reg_type



#–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ —Ä–∞–∑–¥–µ–ª–µ —Ä–µ–µ—Å—Ç—Ä–∞ —Å —É—á–µ—Ç–æ–º –æ—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞
def reset_reg_values(hkey_const, chapter, params, ua_globals, is_exception, run_in_recovery):
    key_handle = None
    hive_name = ua_globals["HKEY_MAP"].get(hkey_const, str(hkey_const))

    # –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—É—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ä–µ–¥—ã
    final_hkey, final_subkey = get_offline_reg_path(hkey_const, chapter, ua_globals, run_in_recovery)

    logger.info(f"UA - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–¥–µ–ª–∞: {hive_name}\\{chapter} (–†–µ–∂–∏–º –∏—Å–∫–ª—é—á–µ–Ω–∏–π: {is_exception})")

    try:
        # –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–ª—é—á —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ —á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å
        # KEY_QUERY_VALUE –Ω—É–∂–µ–Ω –¥–ª—è –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, KEY_SET_VALUE –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è
        key_handle = winreg.OpenKey(final_hkey, final_subkey, 0, winreg.KEY_SET_VALUE | winreg.KEY_QUERY_VALUE | winreg.KEY_ENUMERATE_SUB_KEYS)

        targets = []

        if is_exception:
            # –†–µ–∂–∏–º –∏—Å–∫–ª—é—á–µ–Ω–∏–π: –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ
            try:
                i = 0
                while True:
                    # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É
                    param_name, _, _ = winreg.EnumValue(key_handle, i)
                    # –ï—Å–ª–∏ –∏–º–µ–Ω–∏ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ —Å–±—Ä–æ—Å
                    if param_name not in params:
                        targets.append(param_name)
                    i += 1
            except OSError:
                # OSError –≤–æ–∑–Ω–∏–∫–∞–µ—Ç, –∫–æ–≥–¥–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å
                pass
        else:
            # –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º: —Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å —Ç–µ–º, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–ª–∏ –≤ —Å–ø–∏—Å–∫–µ
            targets = params

        # –ü—Ä–æ—Ü–µ—Å—Å —Å–±—Ä–æ—Å–∞
        for param in targets:
            try:
                # –£—Ç–æ—á–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–∏–ø –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
                _, reg_type = winreg.QueryValueEx(key_handle, param)
                new_val, r_type = get_new_value_for_type(reg_type)

                if new_val is not None:
                    winreg.SetValueEx(key_handle, param, 0, r_type, new_val)
                    logger.success(f'UA - –ü–∞—Ä–∞–º–µ—Ç—Ä "{param}" —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω –≤ {hive_name}\\{chapter}')
                else:
                    logger.warning(f'UA - –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –¥–ª—è "{param}" –≤ {hive_name}\\{chapter}')

            except FileNotFoundError:
                logger.debug(f'UA - –ü–∞—Ä–∞–º–µ—Ç—Ä "{param}" –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫.')
            except Exception as e:
                logger.error(f'UA - –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ "{param}": {e}')

    except FileNotFoundError:
        logger.warning(f"UA - –†–∞–∑–¥–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {hive_name}\\{chapter}")
    except PermissionError:
        logger.critical(f"UA - –û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞–∑–¥–µ–ª—É: {hive_name}\\{chapter}")
    except Exception as e:
        logger.error(f"UA - –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ {chapter}: {e}")
    finally:
        if key_handle:
            winreg.CloseKey(key_handle)



#–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Å–µ–≥–æ
def UA(run_in_recovery):
    try:
        system_hive = loaded_hive_names.get("SYSTEM", "Offline_SYSTEM")
        software_hive = loaded_hive_names.get("SOFTWARE", "Offline_SOFTWARE")
        user_hive = loaded_hive_names.get("USER", "Offline_USER")

        ua_globals = {
            "OFFLINE_HKEY_MAP": {
                winreg.HKEY_LOCAL_MACHINE: (winreg.HKEY_LOCAL_MACHINE, software_hive, r"Software"),
                winreg.HKEY_CURRENT_USER: (winreg.HKEY_LOCAL_MACHINE, user_hive, None)
            },
            "HKEY_MAP": {
                winreg.HKEY_LOCAL_MACHINE: "HKEY_LOCAL_MACHINE",
                winreg.HKEY_CURRENT_USER: "HKEY_CURRENT_USER"
            }
        }

        #–ú—ã—à—å
        #reset_reg_values(winreg.HKEY_CURRENT_USER, r"Control Panel\Mouse", ["SwapMouseButtons"], ua_globals, run_in_recovery)

        #–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–∞
        #explorer_policies = ["NoRun", "NoClose", "NoDriveTypeAutoRun", "NoLogopent", "NoControlPanel", "NoDesktop"]
        #reset_reg_values(winreg.HKEY_CURRENT_USER, r"Software\Microsoft\Windows\CurrentVersion\Policies\Explorer", explorer_policies, ua_globals, run_in_recovery)

        #–°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ (HKCU)
        #system_policies = ["DisableTaskMgr", "DisableRegistryTools", "DisableCMD"]
        #reset_reg_values(winreg.HKEY_CURRENT_USER, r"Software\Microsoft\Windows\CurrentVersion\Policies\System", system_policies, ua_globals, run_in_recovery)

        #–°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ (HKLM)
        #reset_reg_values(winreg.HKEY_LOCAL_MACHINE, r"Software\Microsoft\Windows\CurrentVersion\Policies\System", ["DisableTaskMgr", "ConsentPromptBehaviorAdmin"], ua_globals, run_in_recovery)

        #–°–ø–∏—Å–æ–∫ –ø–æ–ª–∏—Ç–∏–∫ –¥–ª—è —Å–±—Ä–æ—Å–∞
        #–ú—ã—à—å
        reset_reg_values(winreg.HKEY_CURRENT_USER, r"Control Panel\Mouse", ["SwapMouseButtons"], ua_globals, False, run_in_recovery)

        #–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–∞
        reset_reg_values(winreg.HKEY_CURRENT_USER, r"Software\Microsoft\Windows\CurrentVersion\Policies\Explorer", [], ua_globals, True, run_in_recovery)

        #–°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ (HKCU)
        reset_reg_values(winreg.HKEY_CURRENT_USER, r"Software\Microsoft\Windows\CurrentVersion\Policies\System", [], ua_globals, True, run_in_recovery)

        #–°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ (HKLM)
        reset_reg_values(winreg.HKEY_LOCAL_MACHINE, r"Software\Microsoft\Windows\CurrentVersion\Policies\System", [], ua_globals, True, run_in_recovery)
    except Exception as e:
        logger.critical(f"–í –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–µ UnlockAll –ø—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞:\n{e}")

    logger.info("UA - –†–∞–±–æ—Ç–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")

