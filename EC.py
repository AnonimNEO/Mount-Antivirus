#–î–∞–Ω–Ω–æ–µ –°–≤–æ–±–æ–¥–Ω–æ–µ –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ –ª–∏—Ü–µ–Ω–∑–∏–∏ GPL-3.0-only –∏–ª–∏ GPL-3.0-or-later
#–í—ã –∏–º–µ–µ—Ç–µ –ø—Ä–∞–≤–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, –∏–∑–º–µ–Ω—è—Ç—å, —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—Ç—å, –≤–∑–∏–º–∞—Ç—å –ø–ª–∞—Ç—É –∑–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–∫—Ç –ø–µ—Ä–µ–¥–∞—á–∏ –∫–æ–ø–∏–∏, –∏ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ —Å–≤–æ–µ–º—É —É—Å–º–æ—Ç—Ä–µ–Ω–∏—é –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—É—é –∑–∞—â–∏—Ç—É –≤ –æ–±–º–µ–Ω –Ω–∞ –ø–ª–∞—Ç—É
#–î–õ–Ø –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –î–ê–ù–ù–û–ì–û –°–í–û–ë–û–î–ù–û–ì–û –ü–†–û–ì–†–ê–ú–ú–ù–û–ì–û –û–ë–ï–°–ü–ï–ß–ï–ù–ò–Ø, –í–ê–ú –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø –ü–†–ò–ù–Ø–¢–ò–ï –õ–ò–¶–ï–ù–ó–ò–ò Gnu GPL v3.0 –∏–ª–∏ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
#–í –°–õ–£–ß–ê–ï –†–ê–°–ü–†–û–°–¢–†–ê–ù–ï–ù–ò–Ø –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–ô –ü–†–û–ì–†–ê–ú–ú–´ –ò/–ò–õ–ò –ú–û–î–ï–†–ù–ò–ó–ò–†–û–í–ê–ù–ù–û–ô –í–ï–†–°–ò–ò –ò/–ò–õ–ò –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –ò–°–•–û–î–ù–ò–ö–û–í –í –°–í–û–ï–ô –ü–†–û–ì–†–ê–ú–ú–ï, –í–´ –û–ë–Ø–ó–ê–ù–´ –ó–ê–î–û–ö–£–ú–ï–ù–¢–ò–†–û–í–ê–¢–¨ –í–°–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ö–û–î–ï –ò –ü–†–ï–î–û–°–¢–ê–í–ò–¢–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú –í–û–ó–ú–û–ñ–ù–û–°–¢–¨ –ü–û–õ–£–ß–ò–¢–¨ –ò–°–•–û–î–ù–ò–ö–ò –í–ê–®–ï–ô –ö–û–ü–ò–ò –ü–†–û–ì–†–ê–ú–ú–´, –ê –¢–ê–ö–ñ–ï –£–ö–ê–ó–ê–¢–¨ –ê–í–¢–û–†–°–¢–í–û –î–ê–ù–ù–û–ì–û –ü–†–û–ì–†–ê–ú–ú–ù–û–ì–û –û–ë–ï–°–ü–ï–ß–ï–ù–ò–Ø
#–ü–†–ò –†–ê–°–ü–†–û–°–¢–†–ê–ù–ï–ù–ò–ò –ü–†–û–ì–†–ê–ú–ú–´ –í–´ –û–ë–Ø–ó–ê–ù–´ –ü–†–ï–î–û–°–¢–ê–í–ò–¢–¨ –í–°–ï –¢–ï–ñ–ï –ü–†–ê–í–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Æ –ß–¢–û –ò –ú–´ –í–ê–ú, –ê –¢–ê–ö–ñ–ï –õ–ò–¶–ï–ù–ó–ò–Ø GPL v3
#–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é –ª–∏—Ü–µ–Ω–∑–∏–∏ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –§–æ–Ω–¥–∞ –°–≤–æ–±–æ–¥–Ω–æ–≥–æ –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –û–±–µ—Å–ø–µ—á–µ–Ω–∏—è - https://www.gnu.org/licenses/gpl-3.0.html
#–ò–ª–∏ –≤ —Ñ–∞–π–ª–µ COPYING.txt –≤ –∞—Ä—Ö–∏–≤–µ —Å —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–æ–º
#Copyleft üÑØ NEO Organization, Departament K 2024 - 2025
#Coded by @AnonimNEO (Telegram)

#–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –û—à–∏–±–æ–∫
from loguru import logger
#–†–∞–±–æ—Ç–∞ —Å –û–°
from ctypes import wintypes
import ctypes
import psutil

from OF import Psutil

edit_criticality_version = "0.3.2 Beta"

#–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ Windows
kernel32 = ctypes.WinDLL("kernel32", use_last_error=True)
ntdll = ctypes.WinDLL("ntdll", use_last_error=True)

#–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç
PROCESS_QUERY_INFORMATION = 0x0400
PROCESS_SET_INFORMATION = 0x0200
STATUS_SUCCESS = 0

#0x1D (29) - ProcessBreakOnTermination: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏/–∑–∞–ø—Ä–æ—Å–∞ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏.
#–ó–Ω–∞—á–µ–Ω–∏–µ (ULONG): 1 - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π, 0 - –Ω–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
PROCESS_INFORMATION_CLASS_CRITICAL = 0x1D

#–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π Windows API
def define_functions():
    #kernel32.OpenProcess
    kernel32.OpenProcess.argtypes = [wintypes.DWORD, wintypes.BOOL, wintypes.DWORD]
    kernel32.OpenProcess.restype = wintypes.HANDLE

    #kernel32.CloseHandle
    kernel32.CloseHandle.argtypes = [wintypes.HANDLE]
    kernel32.CloseHandle.restype = wintypes.BOOL

    #ntdll.NtSetInformationProcess (–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏)
    ntdll.NtSetInformationProcess.argtypes = [wintypes.HANDLE, wintypes.DWORD, ctypes.c_void_p, wintypes.ULONG]
    ntdll.NtSetInformationProcess.restype = wintypes.LONG

    #ntdll.NtQueryInformationProcess (–î–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏)
    ntdll.NtQueryInformationProcess.argtypes = [
        wintypes.HANDLE,
        wintypes.DWORD, #ProcessInformationClass
        ctypes.c_void_p, #ProcessInformation
        wintypes.ULONG, #ProcessInformationLength
        ctypes.POINTER(wintypes.ULONG) #ReturnLength
    ]
    ntdll.NtQueryInformationProcess.restype = wintypes.LONG

    #ntdll.NtQuerySystemInformation
    ntdll.NtQuerySystemInformation.argtypes = [wintypes.DWORD, ctypes.c_void_p, wintypes.ULONG,
                                              ctypes.POINTER(wintypes.ULONG)]
    ntdll.NtQuerySystemInformation.restype = wintypes.LONG



#–ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø—Ä–æ—Ü–µ—Å—Å–∞
def get_process_name(process_id):
    process = psutil.Process(process_id)
    return process.name()



#–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
def get_process_critical_status(process_id, run_in_recovery):
    if not run_in_recovery:
        import psutil
    elif run_in_recovery:
        psutil = Psutil()

    process_handle = None
    try:
        #–û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Å –ø—Ä–∞–≤–æ–º –Ω–∞ –∑–∞–ø—Ä–æ—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        process_handle = kernel32.OpenProcess(PROCESS_QUERY_INFORMATION, False, process_id)

        if not process_handle:
            return None

        #–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (ULONG, 4 –±–∞–π—Ç–∞)
        critical_value = wintypes.ULONG(0)
        return_length = wintypes.ULONG(0)

        #–í—ã–∑—ã–≤–∞–µ–º NtQueryInformationProcess —Å –∫–ª–∞—Å—Å–æ–º 0x1D
        result = ntdll.NtQueryInformationProcess(
            process_handle,
            PROCESS_INFORMATION_CLASS_CRITICAL,
            ctypes.byref(critical_value),
            ctypes.sizeof(critical_value),
            ctypes.byref(return_length)
        )

        if result == STATUS_SUCCESS:
            return bool(critical_value.value)
        else:
            return None

    except Exception:
        return None
    finally:
        if process_handle:
            kernel32.CloseHandle(process_handle)



#–ú–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–µ
def set_process_critical(process_id, critical):
    process_handle = None
    try:
        #–ü–æ–ª—É—á–∞–µ–º handle –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏ –∑–∞–ø—Ä–æ—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        process_handle = kernel32.OpenProcess(PROCESS_SET_INFORMATION | PROCESS_QUERY_INFORMATION, False, process_id)

        if not process_handle:
            process_name = get_process_name(process_id)
            logger.error(f"EC - –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ü–µ—Å—Å {process_name} (pid: {process_id}). –ö–æ–¥ –æ—à–∏–±–∫–∏: {ctypes.get_last_error()}")
            return False

        #–ó–Ω–∞—á–µ–Ω–∏–µ 1 –¥–ª—è True (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π), 0 –¥–ª—è False (–Ω–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π)
        critical_value = ctypes.c_ulong(1 if critical else 0)

        #–í—ã–∑—ã–≤–∞–µ–º NtSetInformationProcess —Å –∫–ª–∞—Å—Å–æ–º 0x1D
        result = ntdll.NtSetInformationProcess(
            process_handle,
            PROCESS_INFORMATION_CLASS_CRITICAL,
            ctypes.byref(critical_value),
            ctypes.sizeof(critical_value)
        )

        kernel32.CloseHandle(process_handle)

        if result == STATUS_SUCCESS:
            status = "—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞" if critical else "—Å–Ω—è—Ç–∞"
            logger.success(f"EC - –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞ {process_id} {status} (—Ü–µ–ª–µ–≤–æ–µ: {critical})")
            return True
        else:
            logger.error(f"EC - –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏. –ö–æ–¥ –æ—à–∏–±–∫–∏: {hex(result)}")
            return False

    except Exception as e:
        logger.error(f"EC - –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏:\n{e}")
        return False
    finally:
        if process_handle:
            kernel32.CloseHandle(process_handle)



def EC(process_id, critical, debug_mode=False):
    #–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π windows API
    define_functions()

    try:
        process_name = get_process_name(process_id)
        #–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
        if not psutil.pid_exists(process_id):
            if debug_mode:
                logger.error(f"EC - –ü—Ä–æ—Ü–µ—Å—Å {process_name} (pid: {process_id}) –Ω–µ –Ω–∞–π–¥–µ–Ω!")

        if set_process_critical(process_id, critical):
            logger.success(f"EC - –ó–Ω–∞—á–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ {process_name} (pid: {process_id}) –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ critical")
        else:
            logger.error(f"EC - –ó–Ω–∞—á–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ {process_name} (pid: {process_id}) –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ")

    except Exception as e:
        logger.critical(f"–í –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–µ EditCriticality –ø—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞:\n{e}")
